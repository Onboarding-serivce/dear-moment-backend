name: Docker Publish

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 1) 소스코드 체크아웃
      - name: Check out source code
        uses: actions/checkout@v4

      # 2) JDK 설치 (버전 및 distribution 필요에 따라 변경)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3) Gradle 빌드 (프로젝트에 따라 변경: test, assemble, bootJar 등)
      - name: Build using Gradle
        run: ./gradlew build

      # 4) GHCR 로그인
      #    - GHCR_PAT 는 GitHub Actions > Settings > Secrets 에 등록된 Personal Access Token
      #    - 'write:packages' 권한이 있어야 push 가능
      - name: Docker login to GHCR
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      # 5) Docker 이미지 빌드
      #    - Dockerfile이 현재 루트 디렉토리에 있다고 가정 (없다면 --file 옵션 등 조정)
      #    - ghcr.io/${{ github.repository }} => ghcr.io/username/repo
      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/${{ github.repository }}/dear-moment-backend:latest \
            .

      # 6) Docker 이미지 푸시
      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ github.repository }}/dear-moment-backend:latest
